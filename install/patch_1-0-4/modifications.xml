<?xml version="1.0"?>
<!DOCTYPE modification SYSTEM "http://www.elkarte.net/site/modification">
<modification xmlns="http://www.elkarte.net/site/modification" xmlns:elk="http://www.elkarte.net/">

	<id>Elkarte Contributors:ElkArte_104_patch</id>
	<version>1.0</version>
	<file name="BOARDDIR/SSI.php">
		<operation>
			<search position="replace"><![CDATA[ * copyright:	2011 Simple Machines (http://www.simplemachines.org)
 * license:		BSD, See included LICENSE.TXT for terms and conditions.
 *
 * @version 1.0.3
 *
 */
]]></search>
			<add><![CDATA[ * copyright:	2011 Simple Machines (http://www.simplemachines.org)
 * license:		BSD, See included LICENSE.TXT for terms and conditions.
 *
 * @version 1.0.4
 *
 */
]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[define('ELK', 'SSI');

// Shortcut for the browser cache stale
define('CACHE_STALE', '?103');

// We're going to want a few globals... these are all set later.
global $time_start, $maintenance, $msubject, $mmessage, $mbname, $language;]]></search>
			<add><![CDATA[define('ELK', 'SSI');

// Shortcut for the browser cache stale
define('CACHE_STALE', '?104');

// We're going to want a few globals... these are all set later.
global $time_start, $maintenance, $msubject, $mmessage, $mbname, $language;]]></add>
		</operation>
	</file>
	<file name="BOARDDIR/index.php">
		<operation>
			<search position="replace"><![CDATA[ * copyright:	2011 Simple Machines (http://www.simplemachines.org)
 * license:		BSD, See included LICENSE.TXT for terms and conditions.
 *
 * @version 1.0.3
 *
 */

$forum_version = 'ElkArte 1.0.3';
define('FORUM_VERSION', $forum_version);

// First things first, but not necessarily in that order.
define('ELK', 1);

// Shortcut for the browser cache stale
define('CACHE_STALE', '?103');

if (function_exists('set_magic_quotes_runtime'))
	@set_magic_quotes_runtime(0);]]></search>
			<add><![CDATA[ * copyright:	2011 Simple Machines (http://www.simplemachines.org)
 * license:		BSD, See included LICENSE.TXT for terms and conditions.
 *
 * @version 1.0.4
 *
 */

$forum_version = 'ElkArte 1.0.4';
define('FORUM_VERSION', $forum_version);

// First things first, but not necessarily in that order.
define('ELK', 1);

// Shortcut for the browser cache stale
define('CACHE_STALE', '?104');

if (function_exists('set_magic_quotes_runtime'))
	@set_magic_quotes_runtime(0);]]></add>
		</operation>
	</file>
	<file name="SOURCEDIR/BrowserDetector.class.php">
		<operation>
			<search position="replace"><![CDATA[ * copyright:	2011 Simple Machines (http://www.simplemachines.org)
 * license:		BSD, See included LICENSE.TXT for terms and conditions.
 *
 * @version 1.0
 *
 */
]]></search>
			<add><![CDATA[ * copyright:	2011 Simple Machines (http://www.simplemachines.org)
 * license:		BSD, See included LICENSE.TXT for terms and conditions.
 *
 * @version 1.0.4
 *
 */
]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[	{
		if (preg_match('~(?:Firefox|Ice[wW]easel|IceCat|Shiretoko|Minefield)[\/ \(]([^ ;\)]+)~', $this->_ua, $match) === 1)
			$this->_browsers['is_firefox' . (int) $match[1]] = true;
	}

	/**]]></search>
			<add><![CDATA[	{
		if (preg_match('~(?:Firefox|Ice[wW]easel|IceCat|Shiretoko|Minefield)[\/ \(]([^ ;\)]+)~', $this->_ua, $match) === 1)
			$this->_browsers['is_firefox' . (int) $match[1]] = true;

		// Firefox mobile
		if (strpos($this->_ua, 'Android; Mobile;') !== false)
		{
			$this->_browsers['is_android'] = true;
			$this->_is_mobile = true;
		}
		// Tablets as well
		elseif (strpos($this->_ua, 'Android; Tablet;') !== false)
		{
			$this->_browsers['is_android'] = true;
			$this->_browsers['is_android_tablet'] = true;
			$this->_is_tablet = true;
		}
	}

	/**]]></add>
		</operation>
	</file>
	<file name="SOURCEDIR/Errors.php">
		<operation>
			<search position="replace"><![CDATA[ * copyright:	2011 Simple Machines (http://www.simplemachines.org)
 * license:		BSD, See included LICENSE.TXT for terms and conditions.
 *
 * @version 1.0
 *
 */
]]></search>
			<add><![CDATA[ * copyright:	2011 Simple Machines (http://www.simplemachines.org)
 * license:		BSD, See included LICENSE.TXT for terms and conditions.
 *
 * @version 1.0.4
 *
 */
]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
	if ($db_last_error < time() - 3600 * 24 * 3 && empty($maintenance) && !empty($db_error_send))
	{
		// Avoid writing to the Settings.php file if at all possible; use shared memory instead.
		cache_put_data('db_last_error', time(), 600);
		if (($temp = cache_get_data('db_last_error', 600)) === null)
			logLastDatabaseError();]]></search>
			<add><![CDATA[
	if ($db_last_error < time() - 3600 * 24 * 3 && empty($maintenance) && !empty($db_error_send))
	{
		cache_put_data('db_last_error', time(), 600);
		if (($temp = cache_get_data('db_last_error', 600)) === null)
			logLastDatabaseError();]]></add>
		</operation>
	</file>
	<file name="SOURCEDIR/Load.php">
		<operation>
			<search position="replace"><![CDATA[ * copyright:	2011 Simple Machines (http://www.simplemachines.org)
 * license:		BSD, See included LICENSE.TXT for terms and conditions.
 *
 * @version 1.0.3
 *
 */
]]></search>
			<add><![CDATA[ * copyright:	2011 Simple Machines (http://www.simplemachines.org)
 * license:		BSD, See included LICENSE.TXT for terms and conditions.
 *
 * @version 1.0.4
 *
 */
]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[	$context['forum_name'] = $mbname;
	$context['forum_name_html_safe'] = $context['forum_name'];

	// Check loadLanguage actually exists!
	if (!function_exists('loadLanguage'))
		require_once(SOURCEDIR . '/Subs.php');

	loadLanguage('index+Addons');
}
]]></search>
			<add><![CDATA[	$context['forum_name'] = $mbname;
	$context['forum_name_html_safe'] = $context['forum_name'];

	loadLanguage('index+Addons');
}
]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
	// Censoring isn't so very complicated :P.
	if (empty($modSettings['censorWholeWord']))
		$text = empty($modSettings['censorIgnoreCase']) ? str_ireplace($censor_vulgar, $censor_proper, $text) : str_replace($censor_vulgar, $censor_proper, $text);
	else
		$text = preg_replace($censor_vulgar, $censor_proper, $text);
]]></search>
			<add><![CDATA[
	// Censoring isn't so very complicated :P.
	if (empty($modSettings['censorWholeWord']))
		$text = empty($modSettings['censorIgnoreCase']) ? str_replace($censor_vulgar, $censor_proper, $text) : str_ireplace($censor_vulgar, $censor_proper, $text);
	else
		$text = preg_replace($censor_vulgar, $censor_proper, $text);
]]></add>
		</operation>
	</file>
	<file name="SOURCEDIR/Logging.php">
		<operation>
			<search position="replace"><![CDATA[ * copyright:	2011 Simple Machines (http://www.simplemachines.org)
 * license:		BSD, See included LICENSE.TXT for terms and conditions.
 *
 * @version 1.0
 *
 */
]]></search>
			<add><![CDATA[ * copyright:	2011 Simple Machines (http://www.simplemachines.org)
 * license:		BSD, See included LICENSE.TXT for terms and conditions.
 *
 * @version 1.0.4
 *
 */
]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[			// Oops. maybe we have no more disk space left, or some other troubles, troubles...
			// Copy the file back and run for your life!
			@copy(BOARDDIR . '/db_last_error_bak.php', BOARDDIR . '/db_last_error.php');
		}
		else
		{
			@touch(BOARDDIR . '/Settings.php');
			return true;
		}
	}

	return false;]]></search>
			<add><![CDATA[			// Oops. maybe we have no more disk space left, or some other troubles, troubles...
			// Copy the file back and run for your life!
			@copy(BOARDDIR . '/db_last_error_bak.php', BOARDDIR . '/db_last_error.php');
			return false;
		}
		return true;
	}

	return false;]]></add>
		</operation>
	</file>
	<file name="SOURCEDIR/Security.php">
		<operation>
			<search position="replace"><![CDATA[ * copyright:	2011 Simple Machines (http://www.simplemachines.org)
 * license:		BSD, See included LICENSE.TXT for terms and conditions.
 *
 * @version 1.0
 *
 */
]]></search>
			<add><![CDATA[ * copyright:	2011 Simple Machines (http://www.simplemachines.org)
 * license:		BSD, See included LICENSE.TXT for terms and conditions.
 *
 * @version 1.0.4
 *
 */
]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
	// Are we checking the _current_ board, or some other boards?
	if ($boards === null)
		// Check if they can do it, you aren't allowed, by default.
		return count(array_intersect($permission, $user_info['permissions'])) !== 0 ? true : false;

	if (!is_array($boards))
		$boards = array($boards);

	$request = $db->query('', '
		SELECT MIN(bp.add_deny) AS add_deny
		FROM {db_prefix}boards AS b]]></search>
			<add><![CDATA[
	// Are we checking the _current_ board, or some other boards?
	if ($boards === null)
	{
		if (empty($user_info['permissions']))
			return false;

		// Check if they can do it, you aren't allowed, by default.
		return count(array_intersect($permission, $user_info['permissions'])) !== 0 ? true : false;
	}

	if (!is_array($boards))
		$boards = array($boards);

	if (empty($user_info['groups']))
		return false;

	$request = $db->query('', '
		SELECT MIN(bp.add_deny) AS add_deny
		FROM {db_prefix}boards AS b]]></add>
		</operation>
	</file>
	<file name="SOURCEDIR/Subs.php">
		<operation>
			<search position="replace"><![CDATA[ * copyright:	2011 Simple Machines (http://www.simplemachines.org)
 * license:		BSD, See included LICENSE.TXT for terms and conditions.
 *
 * @version 1.0.3
 *
 */
]]></search>
			<add><![CDATA[ * copyright:	2011 Simple Machines (http://www.simplemachines.org)
 * license:		BSD, See included LICENSE.TXT for terms and conditions.
 *
 * @version 1.0.4
 *
 */
]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[	$req = request();

	// Remember this URL in case someone doesn't like sending HTTP_REFERER.
	if (strpos($_SERVER['REQUEST_URL'], 'action=dlattach') === false && strpos($_SERVER['REQUEST_URL'], 'action=viewadminfile') === false && strpos($_SERVER['REQUEST_URL'], ';xml') === false && strpos($_SERVER['REQUEST_URL'], ';api') === false)
		$_SESSION['old_url'] = $_SERVER['REQUEST_URL'];

	// For session check verification.... don't switch browsers...]]></search>
			<add><![CDATA[	$req = request();

	// Remember this URL in case someone doesn't like sending HTTP_REFERER.
	$invalid_old_url = array(
		'action=dlattach',
		'action=jsoption',
		'action=viewadminfile',
		';xml',
		';api',
	);
	$make_old = true;
	foreach ($invalid_old_url as $url)
	{
		if (strpos($_SERVER['REQUEST_URL'], $url) !== false)
		{
			$make_old = false;
			break;
		}
	}
	if ($make_old === true)
		$_SESSION['old_url'] = $_SERVER['REQUEST_URL'];

	// For session check verification.... don't switch browsers...]]></add>
		</operation>
	</file>
	<file name="ADMINDIR/ManageLanguages.controller.php">
		<operation>
			<search position="replace"><![CDATA[ * copyright:	2011 Simple Machines (http://www.simplemachines.org)
 * license:		BSD, See included LICENSE.TXT for terms and conditions.
 *
 * @version 1.0.2
 *
 */
]]></search>
			<add><![CDATA[ * copyright:	2011 Simple Machines (http://www.simplemachines.org)
 * license:		BSD, See included LICENSE.TXT for terms and conditions.
 *
 * @version 1.0.4
 *
 */
]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[			fwrite($fp, $current_data);
			fclose($fp);

			$madeSave = true;
		}
]]></search>
			<add><![CDATA[			fwrite($fp, $current_data);
			fclose($fp);

			if (function_exists('opcache_invalidate'))
				opcache_invalidate($settings['default_theme_dir'] . '/languages/' . $context['lang_id'] . '/index.' . $context['lang_id'] . '.php');

			$madeSave = true;
		}
]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[				fwrite($fp, strtr($file_contents, array("\r" => '')));
				fclose($fp);

				$madeSave = true;
			}
]]></search>
			<add><![CDATA[				fwrite($fp, strtr($file_contents, array("\r" => '')));
				fclose($fp);

				if (function_exists('opcache_invalidate'))
					opcache_invalidate($current_file);

				$madeSave = true;
			}
]]></add>
		</operation>
	</file>
	<file name="ADMINDIR/ManageMaillist.controller.php">
		<operation>
			<search position="replace"><![CDATA[ * @copyright ElkArte Forum contributors
 * @license   BSD http://opensource.org/licenses/BSD-3-Clause
 *
 * @version 1.0.3
 *
 */
]]></search>
			<add><![CDATA[ * @copyright ElkArte Forum contributors
 * @license   BSD http://opensource.org/licenses/BSD-3-Clause
 *
 * @version 1.0.4
 *
 */
]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[					if (in_array($temp_email[0]['error_code'], array('error_not_find_member', 'error_key_sender_match')))
					{
						// did we actually find a potential correct name, if so we post from the valid member
						$check_emails = explode('=>', $temp_email[0]['from']);
						if (isset($check_emails[1]))
							$data = str_ireplace('From: ' . trim($check_emails[0]), 'From: ' . trim($check_emails[1]), $data);
					}

					// Lets TRY AGAIN to make a post!]]></search>
			<add><![CDATA[					if (in_array($temp_email[0]['error_code'], array('error_not_find_member', 'error_key_sender_match')))
					{
						// did we actually find a potential correct name, if so we post from the valid member
						$check_emails = array_pad(explode('=>', $temp_email[0]['from']), 2, '');

						if (!empty($check_emails[1]))
							$data = preg_replace('~(From: )(.*<)?(' . preg_quote(trim($check_emails[0])) . ')(>)?(\n)~i', '$1$2' . trim($check_emails[1]) . '$4$5', $data);
					}

					// Lets TRY AGAIN to make a post!]]></add>
		</operation>
	</file>
	<file name="ADMINDIR/ManageScheduledTasks.controller.php">
		<operation>
			<search position="replace"><![CDATA[ * copyright:	2011 Simple Machines (http://www.simplemachines.org)
 * license:		BSD, See included LICENSE.TXT for terms and conditions.
 *
 * @version 1.0
 *
 */
]]></search>
			<add><![CDATA[ * copyright:	2011 Simple Machines (http://www.simplemachines.org)
 * license:		BSD, See included LICENSE.TXT for terms and conditions.
 *
 * @version 1.0.4
 *
 */
]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[					'data' => array(
						'sprintf' => array(
							'format' => '
								<a href="' . $scripturl . '?action=admin;area=scheduledtasks;sa=taskedit;tid=%1$d"><i class="fa fa-pencil-square-o"></i> %2$s</a><br /><span class="smalltext">%3$s</span>',
							'params' => array(
								'id' => false,
								'name' => false,]]></search>
			<add><![CDATA[					'data' => array(
						'sprintf' => array(
							'format' => '
								<a class="linkbutton" href="' . $scripturl . '?action=admin;area=scheduledtasks;sa=taskedit;tid=%1$d" title="' . $txt['scheduled_task_edit'] . ' %2$s"><i class="fa fa-pencil-square-o"></i> %2$s</a><br /><span class="smalltext">%3$s</span>',
							'params' => array(
								'id' => false,
								'name' => false,]]></add>
		</operation>
	</file>
	<file name="ADMINDIR/ManageSecurity.controller.php">
		<operation>
			<search position="replace"><![CDATA[ * copyright:	2011 Simple Machines (http://www.simplemachines.org)
 * license:		BSD, See included LICENSE.TXT for terms and conditions.
 *
 * @version 1.0
 *
 */
]]></search>
			<add><![CDATA[ * copyright:	2011 Simple Machines (http://www.simplemachines.org)
 * license:		BSD, See included LICENSE.TXT for terms and conditions.
 *
 * @version 1.0.4
 *
 */
]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[		{
			checkSession();

			call_integration_hook('integratesave_moderation_settings', array(&$config_vars));

			// Make sure these don't have an effect.
			if ($modSettings['warning_settings'][0] != 1)
			{]]></search>
			<add><![CDATA[		{
			checkSession();

			// Make sure these don't have an effect.
			if ($modSettings['warning_settings'][0] != 1)
			{]]></add>
		</operation>
	</file>
	<file name="ADMINDIR/ManageThemes.controller.php">
		<operation>
			<search position="replace"><![CDATA[ * copyright:	2011 Simple Machines (http://www.simplemachines.org)
 * license:		BSD, See included LICENSE.TXT for terms and conditions.
 *
 * @version 1.0.2
 *
 *
 * @todo Update this for the new package manager?]]></search>
			<add><![CDATA[ * copyright:	2011 Simple Machines (http://www.simplemachines.org)
 * license:		BSD, See included LICENSE.TXT for terms and conditions.
 *
 * @version 1.0.4
 *
 *
 * @todo Update this for the new package manager?]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[				{
					logAction('editing_theme', array('member' => $user_info['id']), 'admin');

					// But the email only once every 10 minutes should be fine
					if (!recentlyLogged('editing_theme', 600))
					{
						require_once(SUBSDIR . '/Themes.subs.php');
						require_once(SUBSDIR . '/Admin.subs.php');]]></search>
			<add><![CDATA[				{
					logAction('editing_theme', array('member' => $user_info['id']), 'admin');

					// But the email only once every 60 minutes should be fine
					if (!recentlyLogged('editing_theme', 3600))
					{
						require_once(SUBSDIR . '/Themes.subs.php');
						require_once(SUBSDIR . '/Admin.subs.php');]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[				fwrite($fp, $entire_file);
				fclose($fp);

				// We're done here.
				redirectexit('action=admin;area=theme;th=' . $selectedTheme . ';' . $context['session_var'] . '=' . $context['session_id'] . ';sa=browse;directory=' . dirname($_REQUEST['filename']));
			}]]></search>
			<add><![CDATA[				fwrite($fp, $entire_file);
				fclose($fp);

				if (function_exists('opcache_invalidate'))
					opcache_invalidate($theme_dir . '/' . $_REQUEST['filename']);

				// We're done here.
				redirectexit('action=admin;area=theme;th=' . $selectedTheme . ';' . $context['session_var'] . '=' . $context['session_id'] . ';sa=browse;directory=' . dirname($_REQUEST['filename']));
			}]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[			fwrite($fp, file_get_contents($filename));
			fclose($fp);

			redirectexit('action=admin;area=theme;th=' . $context['theme_id'] . ';' . $context['session_var'] . '=' . $context['session_id'] . ';sa=copy');
		}
		elseif (isset($_REQUEST['lang_file']) && preg_match('~^[^\./\\\\:\0]\.[^\./\\\\:\0]$~', $_REQUEST['lang_file']) != 0)]]></search>
			<add><![CDATA[			fwrite($fp, file_get_contents($filename));
			fclose($fp);

			if (function_exists('opcache_invalidate'))
				opcache_invalidate($filename);

			redirectexit('action=admin;area=theme;th=' . $context['theme_id'] . ';' . $context['session_var'] . '=' . $context['session_id'] . ';sa=copy');
		}
		elseif (isset($_REQUEST['lang_file']) && preg_match('~^[^\./\\\\:\0]\.[^\./\\\\:\0]$~', $_REQUEST['lang_file']) != 0)]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[			fwrite($fp, file_get_contents($filename));
			fclose($fp);

			redirectexit('action=admin;area=theme;th=' . $context['theme_id'] . ';' . $context['session_var'] . '=' . $context['session_id'] . ';sa=copy');
		}
]]></search>
			<add><![CDATA[			fwrite($fp, file_get_contents($filename));
			fclose($fp);

			if (function_exists('opcache_invalidate'))
				opcache_invalidate($filename);

			redirectexit('action=admin;area=theme;th=' . $context['theme_id'] . ';' . $context['session_var'] . '=' . $context['session_id'] . ';sa=copy');
		}
]]></add>
		</operation>
	</file>
	<file name="CONTROLLERDIR/Memberlist.controller.php">
		<operation>
			<search position="replace"><![CDATA[ * copyright:	2011 Simple Machines (http://www.simplemachines.org)
 * license:		BSD, See included LICENSE.TXT for terms and conditions.
 *
 * @version 1.0.3
 *
 */
]]></search>
			<add><![CDATA[ * copyright:	2011 Simple Machines (http://www.simplemachines.org)
 * license:		BSD, See included LICENSE.TXT for terms and conditions.
 *
 * @version 1.0.4
 *
 */
]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[ */
class Memberlist_Controller extends Action_Controller
{
	/**
	 * Sets up the context for showing a listing of registered members.
	 * For the handlers in this file, it requires the view_mlist permission.]]></search>
			<add><![CDATA[ */
class Memberlist_Controller extends Action_Controller
{
	protected $_known_search_methods = array();

	public function pre_dispatch()
	{
		global $context, $txt;

		// These are all the possible fields.
		$this->_search_fields = array(
			'name' => $txt['mlist_search_name'],
			'email' => $txt['mlist_search_email'],
			'website' => $txt['mlist_search_website'],
			'group' => $txt['mlist_search_group'],
		);

		// Are there custom fields they can search?
		require_once(SUBSDIR . '/Memberlist.subs.php');
		ml_findSearchableCustomFields();

		// These are handy later
		$context['old_search_value'] = '';
		$context['in_search'] = !empty($_REQUEST['search']);

		foreach ($context['custom_search_fields'] as $field)
			$this->_search_fields['cust_' . $field['colname']] = sprintf($txt['mlist_search_by'], $field['name']);
	}

	/**
	 * Sets up the context for showing a listing of registered members.
	 * For the handlers in this file, it requires the view_mlist permission.]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[		);

		// Add in any custom profile columns
		require_once(SUBSDIR . '/Memberlist.subs.php');
		if (ml_CustomProfile())
			$context['columns'] += $context['custom_profile_fields']['columns'];
]]></search>
			<add><![CDATA[		);

		// Add in any custom profile columns
		if (ml_CustomProfile())
			$context['columns'] += $context['custom_profile_fields']['columns'];
]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[		$context['can_send_pm'] = allowedTo('pm_send');

		// Build the memberlist button array.
		$context['memberlist_buttons'] = array(
			'view_all_members' => array('text' => 'view_all_members', 'image' => 'mlist.png', 'lang' => true, 'url' => $scripturl . '?action=memberlist;sa=all', 'active' => true),
		);

		// Are there custom fields they can search?
		ml_findSearchableCustomFields();

		// These are all the possible fields.
		$context['search_fields'] = array(
			'name' => $txt['mlist_search_name'],
			'email' => $txt['mlist_search_email'],
			'website' => $txt['mlist_search_website'],
			'group' => $txt['mlist_search_group'],
		);

		foreach ($context['custom_search_fields'] as $field)
			$context['search_fields']['cust_' . $field['colname']] = sprintf($txt['mlist_search_by'], $field['name']);

		// What do we search for by default?
		$context['search_defaults'] = array('name', 'email');]]></search>
			<add><![CDATA[		$context['can_send_pm'] = allowedTo('pm_send');

		// Build the memberlist button array.
		if ($context['in_search'])
		{
			$context['memberlist_buttons'] = array(
				'view_all_members' => array('text' => 'view_all_members', 'image' => 'mlist.png', 'lang' => true, 'url' => $scripturl . '?action=memberlist;sa=all', 'active' => true),
			);
		}
		else
			$context['memberlist_buttons'] = array();

		// Make fields available to the template
		$context['search_fields'] = $this->_search_fields;

		// What do we search for by default?
		$context['search_defaults'] = array('name', 'email');]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[			$context['num_members'] = ml_memberCount();

		// Set defaults for sort (real_name) and start. (0)
		if (!isset($_REQUEST['sort']) || !isset($context['columns'][$_REQUEST['sort']]))
			$_REQUEST['sort'] = 'real_name';

		if (!is_numeric($_REQUEST['start']))]]></search>
			<add><![CDATA[			$context['num_members'] = ml_memberCount();

		// Set defaults for sort (real_name) and start. (0)
		if (!isset($_REQUEST['sort']) || !isset($context['columns'][$_REQUEST['sort']]['sort']))
			$_REQUEST['sort'] = 'real_name';

		if (!is_numeric($_REQUEST['start']))]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
				if ($this_letter != $last_letter && preg_match('~[a-z]~', $this_letter) === 1)
				{
					$context['members'][$i]['sort_letter'] = htmlspecialchars($this_letter, ENT_COMPAT, 'UTF-8');
					$last_letter = $this_letter;
				}
			}]]></search>
			<add><![CDATA[
				if ($this_letter != $last_letter && preg_match('~[a-z]~', $this_letter) === 1)
				{
					$context['members'][$i]['sort_letter'] = Util::htmlspecialchars($this_letter);
					$last_letter = $this_letter;
				}
			}]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[		$context['page_title'] = $txt['mlist_search'];
		$context['can_moderate_forum'] = allowedTo('moderate_forum');

		// Are there custom fields they can search?
		ml_findSearchableCustomFields();

		// They're searching..
		if (isset($_REQUEST['search']) && isset($_REQUEST['fields']))
		{
			$search = Util::htmlspecialchars(trim(isset($_GET['search']) ? $_GET['search'] : $_POST['search']), ENT_QUOTES);
			$input_fields = isset($_GET['fields']) ? explode(',', $_GET['fields']) : $_POST['fields'];

			$context['old_search'] = $_REQUEST['search'];
			$context['old_search_value'] = urlencode($_REQUEST['search']);

			// No fields?  Use default...
			if (empty($input_fields))]]></search>
			<add><![CDATA[		$context['page_title'] = $txt['mlist_search'];
		$context['can_moderate_forum'] = allowedTo('moderate_forum');

		// They're searching..
		if (isset($_REQUEST['search']) && isset($_REQUEST['fields']))
		{
			$search = Util::htmlspecialchars(trim(isset($_GET['search']) ? $_GET['search'] : $_POST['search']), ENT_QUOTES);
			$input_fields = isset($_GET['fields']) ? explode(',', $_GET['fields']) : $_POST['fields'];

			$fields_key = array_keys($this->_search_fields);
			$context['search_defaults'] = array();
			foreach ($input_fields as $val)
			{
				if (in_array($val, $fields_key))
					$context['search_defaults'] = $input_fields;
			}
			$context['old_search_value'] = $search;

			// No fields?  Use default...
			if (empty($input_fields))]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
			$customJoin = array();
			$customCount = 10;
			$validFields = array();

			// Any custom fields to search for - these being tricky?
			foreach ($input_fields as $field)]]></search>
			<add><![CDATA[
			$customJoin = array();
			$customCount = 10;
			$validFields = isset($input_fields) ? $input_fields : array();

			// Any custom fields to search for - these being tricky?
			foreach ($input_fields as $field)]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[			if (empty($fields))
				redirectexit('action=memberlist');

			$query = $search == '' ? '= {string:blank_string}' : (defined('DB_CASE_SENSITIVE') ? 'LIKE LOWER({string:search})' : 'LIKE {string:search}');
			$where = implode(' ' . $query . ' OR ', $fields) . ' ' . $query . $condition;
]]></search>
			<add><![CDATA[			if (empty($fields))
				redirectexit('action=memberlist');

			$validFields = array_unique($validFields);
			$query = $search == '' ? '= {string:blank_string}' : (defined('DB_CASE_SENSITIVE') ? 'LIKE LOWER({string:search})' : 'LIKE {string:search}');
			$where = implode(' ' . $query . ' OR ', $fields) . ' ' . $query . $condition;
]]></add>
		</operation>
	</file>
	<file name="CONTROLLERDIR/Mentions.controller.php">
		<operation>
			<search position="replace"><![CDATA[ * @copyright ElkArte Forum contributors
 * @license   BSD http://opensource.org/licenses/BSD-3-Clause
 *
 * @version 1.0
 *
 */
]]></search>
			<add><![CDATA[ * @copyright ElkArte Forum contributors
 * @license   BSD http://opensource.org/licenses/BSD-3-Clause
 *
 * @version 1.0.4
 *
 */
]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[		global $txt, $scripturl, $context, $modSettings, $user_info;

		$boards = array();
		$removed = false;

		foreach ($mentions as $key => $row)]]></search>
			<add><![CDATA[		global $txt, $scripturl, $context, $modSettings, $user_info;

		$boards = array();
		$unset_keys = array();
		$removed = false;

		foreach ($mentions as $key => $row)]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
			// These things are associated to messages and require permission checks
			if (in_array($row['mention_type'], array('men', 'like', 'rlike')))
				$boards[$key] = $row['id_board'];

			$mentions[$key]['message'] = str_replace(
				array(]]></search>
			<add><![CDATA[
			// These things are associated to messages and require permission checks
			if (in_array($row['mention_type'], array('men', 'like', 'rlike')))
			{
				if (empty($row['id_board']))
					$unset_keys[] = $key;
				else
					$boards[$key] = $row['id_board'];
			}

			$mentions[$key]['message'] = str_replace(
				array(]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[				// You can't see the board where this mention is, so we drop it from the results
				if (!in_array($board, $accessibleBoards))
				{
					$removed = true;
					unset($mentions[$key]);
				}
			}
		}

		// If some of these mentions are no longer visable, we need to do some maintenance
		if ($removed)
		{
			if (!empty($modSettings['user_access_mentions']))
				$modSettings['user_access_mentions'] = @unserialize($modSettings['user_access_mentions']);
			else]]></search>
			<add><![CDATA[				// You can't see the board where this mention is, so we drop it from the results
				if (!in_array($board, $accessibleBoards))
				{
					$unset_keys[] = $key;
				}
			}
		}

		// If some of these mentions are no longer visable, we need to do some maintenance
		if (!empty($unset_keys))
		{
			$removed = true;
			foreach ($unset_keys as  $key)
				unset($mentions[$key]);

			if (!empty($modSettings['user_access_mentions']))
				$modSettings['user_access_mentions'] = @unserialize($modSettings['user_access_mentions']);
			else]]></add>
		</operation>
	</file>
	<file name="CONTROLLERDIR/Post.controller.php">
		<operation>
			<search position="replace"><![CDATA[ * copyright:	2011 Simple Machines (http://www.simplemachines.org)
 * license:		BSD, See included LICENSE.TXT for terms and conditions.
 *
 * @version 1.0.1
 *
 */
]]></search>
			<add><![CDATA[ * copyright:	2011 Simple Machines (http://www.simplemachines.org)
 * license:		BSD, See included LICENSE.TXT for terms and conditions.
 *
 * @version 1.0.4
 *
 */
]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[			// If the number of replies has changed, if the setting is enabled, go back to action_post() - which handles the error.
			if (empty($options['no_new_reply_warning']) && isset($_POST['last_msg']) && $topic_info['id_last_msg'] > $_POST['last_msg'])
			{
				$_REQUEST['preview'] = true;
				return $this->action_post();
			}
]]></search>
			<add><![CDATA[			// If the number of replies has changed, if the setting is enabled, go back to action_post() - which handles the error.
			if (empty($options['no_new_reply_warning']) && isset($_POST['last_msg']) && $topic_info['id_last_msg'] > $_POST['last_msg'])
			{
				addInlineJavascript('
					$(document).ready(function () {
						$("html,body").scrollTop($(\'.category_header:visible:first\').offset().top);
					});'
				);

				return $this->action_post();
			}
]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[		// Any mistakes?
		if ($post_errors->hasErrors() || $attach_errors->hasErrors())
		{
			// Previewing.
			$_REQUEST['preview'] = true;

			return $this->action_post();
		}]]></search>
			<add><![CDATA[		// Any mistakes?
		if ($post_errors->hasErrors() || $attach_errors->hasErrors())
		{
			addInlineJavascript('
				$(document).ready(function () {
					$("html,body").scrollTop($(\'.category_header:visible:first\').offset().top);
				});'
			);

			return $this->action_post();
		}]]></add>
		</operation>
	</file>
	<file name="CONTROLLERDIR/RemoveTopic.controller.php">
		<operation>
			<search position="replace"><![CDATA[ * copyright:	2011 Simple Machines (http://www.simplemachines.org)
 * license:		BSD, See included LICENSE.TXT for terms and conditions.
 *
 * @version 1.0.3
 *
 */
]]></search>
			<add><![CDATA[ * copyright:	2011 Simple Machines (http://www.simplemachines.org)
 * license:		BSD, See included LICENSE.TXT for terms and conditions.
 *
 * @version 1.0.4
 *
 */
]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[			fatal_lang_error('restore_not_found', false, array('<ul style="margin-top: 0px;"><li>' . implode('</li><li>', $unfound_messages) . '</li></ul>'));

		// Lets send them back somewhere that may make sense
		if (count($actioned_messages) == 1 && empty($topics_to_restore))
		{
			reset($actioned_messages);
			redirectexit('topic=' . key($actioned_messages));]]></search>
			<add><![CDATA[			fatal_lang_error('restore_not_found', false, array('<ul style="margin-top: 0px;"><li>' . implode('</li><li>', $unfound_messages) . '</li></ul>'));

		// Lets send them back somewhere that may make sense
		if (isset($actioned_messages) && count($actioned_messages) == 1 && empty($topics_to_restore))
		{
			reset($actioned_messages);
			redirectexit('topic=' . key($actioned_messages));]]></add>
		</operation>
	</file>
	<file name="SOURCEDIR/database/Db-mysql.class.php">
		<operation>
			<search position="replace"><![CDATA[ * copyright:	2004-2011, GreyWyvern - All rights reserved.
 * license:  	BSD, See included LICENSE.TXT for terms and conditions.
 *
 * @version 1.0
 *
 */
]]></search>
			<add><![CDATA[ * copyright:	2004-2011, GreyWyvern - All rights reserved.
 * license:  	BSD, See included LICENSE.TXT for terms and conditions.
 *
 * @version 1.0.4
 *
 */
]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[			// Check for the "lost connection" or "deadlock found" errors - and try it just one more time.
			if (in_array($query_errno, array(1205, 1213, 2006, 2013)))
			{
				if (in_array($query_errno, array(2006, 2013)) && $this->_connection == $connection)
				{
					// Are we in SSI mode?  If so try that username and password first]]></search>
			<add><![CDATA[			// Check for the "lost connection" or "deadlock found" errors - and try it just one more time.
			if (in_array($query_errno, array(1205, 1213, 2006, 2013)))
			{
				$new_connection = false;
				if (in_array($query_errno, array(2006, 2013)) && $this->_connection == $connection)
				{
					// Are we in SSI mode?  If so try that username and password first]]></add>
		</operation>
	</file>
	<file name="SUBSDIR/Admin.subs.php">
		<operation>
			<search position="replace"><![CDATA[ * copyright:	2011 Simple Machines (http://www.simplemachines.org)
 * license:  	BSD, See included LICENSE.TXT for terms and conditions.
 *
 * @version 1.0
 *
 * This file contains functions that are specifically done by administrators.
 *]]></search>
			<add><![CDATA[ * copyright:	2011 Simple Machines (http://www.simplemachines.org)
 * license:  	BSD, See included LICENSE.TXT for terms and conditions.
 *
 * @version 1.0.4
 *
 * This file contains functions that are specifically done by administrators.
 *]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[{
	// Write out the db_last_error file with the error timestamp
	file_put_contents(BOARDDIR . '/db_last_error.php', '<' . '?' . "php\n" . '$db_last_error = ' . $time . ';', LOCK_EX);
	@touch(BOARDDIR . '/Settings.php');
}

/**]]></search>
			<add><![CDATA[{
	// Write out the db_last_error file with the error timestamp
	file_put_contents(BOARDDIR . '/db_last_error.php', '<' . '?' . "php\n" . '$db_last_error = ' . $time . ';', LOCK_EX);
}

/**]]></add>
		</operation>
	</file>
	<file name="SUBSDIR/Editor.subs.php">
		<operation>
			<search position="replace"><![CDATA[			$context['drafts_autosave_frequency'] = empty($modSettings['drafts_autosave_frequency']) ? 30000 : $modSettings['drafts_autosave_frequency'] * 1000;

		// This really has some WYSIWYG stuff.
		loadTemplate('GenericControls', 'jquery.sceditor');
		if (!empty($context['theme_variant']) && file_exists($settings['theme_dir'] . '/css/' . $context['theme_variant'] . '/jquery.sceditor.elk' . $context['theme_variant'] . '.css'))
			loadCSSFile($context['theme_variant'] . '/jquery.sceditor.elk' . $context['theme_variant'] . '.css');
]]></search>
			<add><![CDATA[			$context['drafts_autosave_frequency'] = empty($modSettings['drafts_autosave_frequency']) ? 30000 : $modSettings['drafts_autosave_frequency'] * 1000;

		// This really has some WYSIWYG stuff.
		loadTemplate('GenericControls');
		loadCSSFile('jquery.sceditor.css');
		if (!empty($context['theme_variant']) && file_exists($settings['theme_dir'] . '/css/' . $context['theme_variant'] . '/jquery.sceditor.elk' . $context['theme_variant'] . '.css'))
			loadCSSFile($context['theme_variant'] . '/jquery.sceditor.elk' . $context['theme_variant'] . '.css');
]]></add>
		</operation>
	</file>
	<file name="SUBSDIR/Graphics.subs.php">
		<operation>
			<search position="replace"><![CDATA[ * copyright:	2011 Simple Machines (http://www.simplemachines.org)
 * license:  	BSD, See included LICENSE.TXT for terms and conditions.
 *
 * @version 1.0
 *
 */
]]></search>
			<add><![CDATA[ * copyright:	2011 Simple Machines (http://www.simplemachines.org)
 * license:  	BSD, See included LICENSE.TXT for terms and conditions.
 *
 * @version 1.0.4
 *
 */
]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[			// Get a new instance of Imagick for use
			$imagick = new Imagick($destName);

			// Set the input and output image size
			$src_width = empty($src_width) ? $imagick->getImageWidth() : $src_width;
			$src_height = empty($src_height) ? $imagick->getImageHeight() : $src_height;]]></search>
			<add><![CDATA[			// Get a new instance of Imagick for use
			$imagick = new Imagick($destName);

			// Fix image rotations for iphone cameras etc.
			autoRotateImage($imagick);

			// Set the input and output image size
			$src_width = empty($src_width) ? $imagick->getImageWidth() : $src_width;
			$src_height = empty($src_height) ? $imagick->getImageHeight() : $src_height;]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[}

/**
 * Copy / resize an image using GD bicubic methods
 *
 * - Used when imagecopyresample() is not available]]></search>
			<add><![CDATA[}

/**
 * Autorotate an image based on its EXIF Orientation tag.
 *
 * - ImageMagick only
 * - Checks exif data for orientation flag and rotates image so its proper
 * - Updates orientation flag if rotation was required
 *
 * @param object $image
 */
function autoRotateImage($image)
{
	// This method should exist if Imagick has been compiled against ImageMagick version
	// 6.3.0 or higher which is forever ago, but we check anyway ;)
	if (!method_exists($image , 'getImageOrientation'))
		return;

	$orientation = $image->getImageOrientation();

	switch ($orientation)
	{
		// (0 & 1) Not set or Normal
		case imagick::ORIENTATION_UNDEFINED:
		case imagick::ORIENTATION_TOPLEFT:
			break;
		// (2) Mirror image, Normal orientation
		case imagick::ORIENTATION_TOPRIGHT:
			$image->flopImage();
			break;
		// (3) Normal image, rotated 180
		case imagick::ORIENTATION_BOTTOMRIGHT:
			$image->rotateImage("#000", 180);
			break;
		// (4) Mirror image, rotated 180
		case imagick::ORIENTATION_BOTTOMLEFT:
			$image->rotateImage("#000", 180);
			$image->flopImage();
			break;
		// (5) Mirror image, rotated 90 CCW
		case imagick::ORIENTATION_LEFTTOP:
			$image->rotateImage("#000", 90);
			$image->flopImage();
			break;
		// (6) Normal image, rotated 90 CCW
		case imagick::ORIENTATION_RIGHTTOP:
			$image->rotateImage("#000", 90);
			break;
		// (7) Mirror image, rotated 90 CW
		case imagick::ORIENTATION_RIGHTBOTTOM:
			$image->rotateImage("#000", -90);
			$image->flopImage();
			break;
		// (8) Normal image, rotated 90 CW
		case imagick::ORIENTATION_LEFTBOTTOM:
			$image->rotateImage("#000", -90);
			break;
	}

	// Now that it's auto-rotated, make sure the EXIF data is correctly updated
	if ($orientation >= 2)
		$image->setImageOrientation(imagick::ORIENTATION_TOPLEFT);
}

/**
 * Copy / resize an image using GD bicubic methods
 *
 * - Used when imagecopyresample() is not available]]></add>
		</operation>
	</file>
	<file name="SUBSDIR/Html2Md.class.php">
		<operation>
			<search position="replace"><![CDATA[ * @copyright ElkArte Forum contributors
 * @license   BSD http://opensource.org/licenses/BSD-3-Clause
 *
 * @version 1.0
 *
 */
]]></search>
			<add><![CDATA[ * @copyright ElkArte Forum contributors
 * @license   BSD http://opensource.org/licenses/BSD-3-Clause
 *
 * @version 1.0.4
 *
 */
]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[	 * Wordwrap output, set to 0 to skip wrapping
	 * @var int
	 */
	public $body_width = 80;

	/**
	 * Strip remaining tags, set to false to leave them in]]></search>
			<add><![CDATA[	 * Wordwrap output, set to 0 to skip wrapping
	 * @var int
	 */
	public $body_width = 76;

	/**
	 * Strip remaining tags, set to false to leave them in]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[		// Up front, remove whitespace between html tags
		$html = preg_replace('/(?:(?<=\>)|(?<=\/\>))(\s+)(?=\<\/?)/', '', $html);

		// Using PHP built in functions ...
		if (class_exists('DOMDocument'))
		{]]></search>
			<add><![CDATA[		// Up front, remove whitespace between html tags
		$html = preg_replace('/(?:(?<=\>)|(?<=\/\>))(\s+)(?=\<\/?)/', '', $html);

		// The XML parser will not fix these for us
		$html = strtr($html, array('?<' => '?&LT;', '?>' => '?&GT;') );

		// Using PHP built in functions ...
		if (class_exists('DOMDocument'))
		{]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[	 */
	private function _utf8_wordwrap($string, $width = 75, $break = "\n")
	{
		$lines = array();
		while (!empty($string))
		{
			// Get the next #width characters before a break (space, tab etc)
			if (preg_match('~^(.{1,' . $width . '})(?:\s|$)~', $string, $matches))
			{
				// Add the #width to the output and set up for the next pass
				$lines[] = $matches[1];
				$string = Util::substr($string, Util::strlen($matches[0]));
			}
			// Humm just a long word with no place to break, so we simply cut it after width characters
			else
			{
				$lines[] = Util::substr($string, 0, $width);
				$string = Util::substr($string, $width);
			}
		}
]]></search>
			<add><![CDATA[	 */
	private function _utf8_wordwrap($string, $width = 75, $break = "\n")
	{
		$strings = explode($break, $string);
		$lines = array();

		foreach ($strings as $string)
		{
			$in_quote = isset($string[0]) && $string[0] === '>';
			while (!empty($string))
			{
				// Get the next #width characters before a break (space, punctuation tab etc)
				if (preg_match('~^(.{1,' . $width . '})(?:\s|$|,|\.)~', $string, $matches))
				{
					// Add the #width to the output and set up for the next pass
					$lines[] = ($in_quote && $matches[1][0] !== '>' ? '> ' : '') . $matches[1];
					$string = Util::substr($string, Util::strlen($matches[1]));
				}
				// Humm just a long word with no place to break so we simply cut it after width characters
				else
				{
					$lines[] = ($in_quote && $string[0] !== '>' ? '> ' : '') . Util::substr($string, 0, $width);
					$string = Util::substr($string, $width);
				}
			}
		}
]]></add>
		</operation>
	</file>
	<file name="SUBSDIR/Memberlist.subs.php">
		<operation>
			<search position="replace"><![CDATA[ * copyright:	2011 Simple Machines (http://www.simplemachines.org)
 * license:  	BSD, See included LICENSE.TXT for terms and conditions.
 *
 * @version 1.0.3
 *
 */
]]></search>
			<add><![CDATA[ * copyright:	2011 Simple Machines (http://www.simplemachines.org)
 * license:  	BSD, See included LICENSE.TXT for terms and conditions.
 *
 * @version 1.0.4
 *
 */
]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[		WHERE active = {int:active}
			' . (allowedTo('admin_forum') ? '' : ' AND private < {int:private_level}') . '
			AND can_search = {int:can_search}
			AND (field_type = {string:field_type_text} OR field_type = {string:field_type_textarea})',
		array(
			'active' => 1,
			'can_search' => 1,
			'private_level' => 2,
			'field_type_text' => 'text',
			'field_type_textarea' => 'textarea',
		)
	);
	$context['custom_search_fields'] = array();]]></search>
			<add><![CDATA[		WHERE active = {int:active}
			' . (allowedTo('admin_forum') ? '' : ' AND private < {int:private_level}') . '
			AND can_search = {int:can_search}
			AND (field_type IN ({string:field_type_text}, {string:field_type_textarea}, {string:field_type_select}))',
		array(
			'active' => 1,
			'can_search' => 1,
			'private_level' => 2,
			'field_type_text' => 'text',
			'field_type_textarea' => 'textarea',
			'field_type_select' => 'select',
		)
	);
	$context['custom_search_fields'] = array();]]></add>
		</operation>
	</file>
	<file name="SUBSDIR/Mentions.subs.php">
		<operation>
			<search position="replace"><![CDATA[ * @copyright ElkArte Forum contributors
 * @license   BSD http://opensource.org/licenses/BSD-3-Clause
 *
 * @version 1.0
 *
 */
]]></search>
			<add><![CDATA[ * @copyright ElkArte Forum contributors
 * @license   BSD http://opensource.org/licenses/BSD-3-Clause
 *
 * @version 1.0.4
 *
 */
]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[}

/**
 * Toggles a mention on/off
 *
 * - This is used to turn mentions on when a message is approved]]></search>
			<add><![CDATA[}

/**
 * Completely remove from the database a set of mentions.
 *
 * Doesn't check permissions, access, anything. It just deletes everything.
 *
 * @package Mentions
 * @param int[] $id_mentions the mention ids
 */
function removeMentions($id_mentions)
{
	global $user_info;

	$db = database();

	$db->query('', '
		DELETE FROM {db_prefix}log_mentions
		WHERE id_mention IN ({array_int:id_mentions})',
		array(
			'id_mentions' => $id_mentions,
		)
	);
	$success = $db->affected_rows() != 0;

	// Update the top level mentions count
	if ($success)
		updateMentionMenuCount($status, $user_info['id']);

	return $success;
}

/**
 * Toggles a mention on/off
 *
 * - This is used to turn mentions on when a message is approved]]></add>
		</operation>
	</file>
	<file name="SUBSDIR/Package.subs.php">
		<operation>
			<search position="replace"><![CDATA[ * copyright:	2011 Simple Machines (http://www.simplemachines.org)
 * license:  	BSD, See included LICENSE.TXT for terms and conditions.
 *
 * @version 1.0.3
 *
 */
]]></search>
			<add><![CDATA[ * copyright:	2011 Simple Machines (http://www.simplemachines.org)
 * license:  	BSD, See included LICENSE.TXT for terms and conditions.
 *
 * @version 1.0.4
 *
 */
]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[ */
function getPackageInfo($gzfilename)
{
	// Extract package-info.xml from downloaded file. (*/ is used because it could be in any directory.)
	if (preg_match('~^https?://~i', $gzfilename) === 1)
		$packageInfo = read_tgz_data(fetch_web_data($gzfilename, '', true), '*/package-info.xml', true);]]></search>
			<add><![CDATA[ */
function getPackageInfo($gzfilename)
{
	$gzfilename = trim($gzfilename);

	// Extract package-info.xml from downloaded file. (*/ is used because it could be in any directory.)
	if (preg_match('~^https?://~i', $gzfilename) === 1)
		$packageInfo = read_tgz_data(fetch_web_data($gzfilename, '', true), '*/package-info.xml', true);]]></add>
		</operation>
	</file>
	<file name="SUBSDIR/ScheduledTask.class.php">
		<operation>
			<search position="replace"><![CDATA[ * copyright:	2011 Simple Machines (http://www.simplemachines.org)
 * license:  	BSD, See included LICENSE.TXT for terms and conditions.
 *
 * @version 1.0.3
 *
 */
]]></search>
			<add><![CDATA[ * copyright:	2011 Simple Machines (http://www.simplemachines.org)
 * license:  	BSD, See included LICENSE.TXT for terms and conditions.
 *
 * @version 1.0.4
 *
 */
]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[		{
			// We need to do some shuffling to make this work properly.
			loadLanguage('EmailTemplates', $lang);
			$txt['emails']['happy_birthday']['subject'] = $txtBirthdayEmails[$greeting . '_subject'];
			$txt['emails']['happy_birthday']['body'] = $txtBirthdayEmails[$greeting . '_body'];

			foreach ($recps as $recp)
			{]]></search>
			<add><![CDATA[		{
			// We need to do some shuffling to make this work properly.
			loadLanguage('EmailTemplates', $lang);
			$txt['happy_birthday_subject'] = $txtBirthdayEmails[$greeting . '_subject'];
			$txt['happy_birthday_body'] = $txtBirthdayEmails[$greeting . '_body'];

			foreach ($recps as $recp)
			{]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[		}

		// Flush the mail queue, just in case.
		AddMailQueue(true);

		return true;
	}]]></search>
			<add><![CDATA[		}

		// Flush the mail queue, just in case.
		if (!empty($modSettings['mail_queue']))
			AddMailQueue(true);

		return true;
	}]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[					{
						// Find all the mentions that this user can or cannot see
						$request = $db->query('', '
							SELECT mnt.id_mention
							FROM {db_prefix}log_mentions as mnt
								LEFT JOIN {db_prefix}messages AS m ON (m.id_msg = mnt.id_msg)
								LEFT JOIN {db_prefix}boards AS b ON (b.id_board = m.id_board)]]></search>
			<add><![CDATA[					{
						// Find all the mentions that this user can or cannot see
						$request = $db->query('', '
							SELECT mnt.id_mention, m.id_board
							FROM {db_prefix}log_mentions as mnt
								LEFT JOIN {db_prefix}messages AS m ON (m.id_msg = mnt.id_msg)
								LEFT JOIN {db_prefix}boards AS b ON (b.id_board = m.id_board)]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[							)
						);
						$mentions = array();
						while ($row = $db->fetch_assoc($request))
							$mentions[] = $row['id_mention'];
						$db->free_result($request);

						// If we found something toggle them and increment the start for the next round
						if (!empty($mentions))
							toggleMentionsAccessibility($mentions, $can == 'can');]]></search>
			<add><![CDATA[							)
						);
						$mentions = array();
						$remove = array();
						while ($row = $db->fetch_assoc($request))
						{
							if (empty($row['id_board']))
								$remove[] = $row['id_mention'];
							else
								$mentions[] = $row['id_mention'];
						}
						$db->free_result($request);

						if (!empty($remove))
						{
							removeMentions($remove);
						}
						// If we found something toggle them and increment the start for the next round
						if (!empty($mentions))
							toggleMentionsAccessibility($mentions, $can == 'can');]]></add>
		</operation>
	</file>
	<file name="SUBSDIR/SettingsForm.class.php">
		<operation>
			<search position="replace"><![CDATA[ * copyright:	2011 Simple Machines (http://www.simplemachines.org)
 * license:  	BSD, See included LICENSE.TXT for terms and conditions.
 *
 * @version 1.0.2
 *
 *
 * Adding options to one of the setting screens isn't hard.]]></search>
			<add><![CDATA[ * copyright:	2011 Simple Machines (http://www.simplemachines.org)
 * license:  	BSD, See included LICENSE.TXT for terms and conditions.
 *
 * @version 1.0.4
 *
 *
 * Adding options to one of the setting screens isn't hard.]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[				if (file_exists(BOARDDIR . '/Settings_bak.php'))
					@copy(BOARDDIR . '/Settings_bak.php', BOARDDIR . '/Settings.php');
			}
		}
	}
]]></search>
			<add><![CDATA[				if (file_exists(BOARDDIR . '/Settings_bak.php'))
					@copy(BOARDDIR . '/Settings_bak.php', BOARDDIR . '/Settings.php');
			}
			// And ensure we are going to read the correct file next time
			if (function_exists('opcache_invalidate'))
				opcache_invalidate(BOARDDIR . '/Settings.php');
		}
	}
]]></add>
		</operation>
	</file>
	<file name="SUBSDIR/Topic.subs.php">
		<operation>
			<search position="replace"><![CDATA[ * copyright:	2011 Simple Machines (http://www.simplemachines.org)
 * license:  	BSD, See included LICENSE.TXT for terms and conditions.
 *
 * @version 1.0.3
 *
 */
]]></search>
			<add><![CDATA[ * copyright:	2011 Simple Machines (http://www.simplemachines.org)
 * license:  	BSD, See included LICENSE.TXT for terms and conditions.
 *
 * @version 1.0.4
 *
 */
]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[	{
		if (!isset($adjustBoards[$row['id_board']]['num_posts']))
		{
			$adjustBoards[$row['id_board']] = array(
				'num_posts' => 0,
				'num_topics' => 0,]]></search>
			<add><![CDATA[	{
		if (!isset($adjustBoards[$row['id_board']]['num_posts']))
		{
			cache_put_data('board-' . $row['id_board'], null, 120);

			$adjustBoards[$row['id_board']] = array(
				'num_posts' => 0,
				'num_topics' => 0,]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[	require_once(SUBSDIR . '/FollowUps.subs.php');
	removeFollowUpsByTopic($topics);

	// Maybe there's an addon that wants to delete topic related data of its own
	call_integration_hook('integrate_remove_topics', array($topics));
]]></search>
			<add><![CDATA[	require_once(SUBSDIR . '/FollowUps.subs.php');
	removeFollowUpsByTopic($topics);

	foreach ($topics as $topic_id)
		cache_put_data('topic_board-' . $topic_id, null, 120);

	// Maybe there's an addon that wants to delete topic related data of its own
	call_integration_hook('integrate_remove_topics', array($topics));
]]></add>
		</operation>
	</file>
	<file name="THEMEDIR/Display.template.php">
		<operation>
			<search position="replace"><![CDATA[ * copyright:	2011 Simple Machines (http://www.simplemachines.org)
 * license:  	BSD, See included LICENSE.TXT for terms and conditions.
 *
 * @version 1.0.3
 *
 */
]]></search>
			<add><![CDATA[ * copyright:	2011 Simple Machines (http://www.simplemachines.org)
 * license:  	BSD, See included LICENSE.TXT for terms and conditions.
 *
 * @version 1.0.4
 *
 */
]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[		echo '
							</ul>
							<div class="submitbutton">
								<input type="submit" value="', $txt['poll_vote'], '" class="button_submit" />
								<input type="hidden" name="', $context['session_var'], '" value="', $context['session_id'], '" />
							</div>
						</form>';]]></search>
			<add><![CDATA[		echo '
							</ul>
							<div class="submitbutton">
								<input type="submit" value="', $txt['poll_vote'], '" class="left_submit" />
								<input type="hidden" name="', $context['session_var'], '" value="', $context['session_id'], '" />
							</div>
						</form>';]]></add>
		</operation>
	</file>
	<file name="THEMEDIR/GenericControls.template.php">
		<operation>
			<search position="replace"><![CDATA[ * copyright:	2011 Simple Machines (http://www.simplemachines.org)
 * license:  	BSD, See included LICENSE.TXT for terms and conditions.
 *
 * @version 1.0.1
 *
 */
]]></search>
			<add><![CDATA[ * copyright:	2011 Simple Machines (http://www.simplemachines.org)
 * license:  	BSD, See included LICENSE.TXT for terms and conditions.
 *
 * @version 1.0.4
 *
 */
]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[	echo '
			', $context['shortcuts_text'], '
		</span>
		<input type="submit" value="', isset($editor_context['labels']['post_button']) ? $editor_context['labels']['post_button'] : $txt['post'], '" tabindex="', $context['tabindex']++, '" onclick="return submitThisOnce(this);" accesskey="s" class="button_submit" />';

	if ($editor_context['preview_type'])
		echo ']]></search>
			<add><![CDATA[	echo '
			', $context['shortcuts_text'], '
		</span>
		<input type="submit" name="', isset($editor_context['labels']['post_name']) ? $editor_context['labels']['post_name'] : 'post', '" value="', isset($editor_context['labels']['post_button']) ? $editor_context['labels']['post_button'] : $txt['post'], '" tabindex="', $context['tabindex']++, '" onclick="return submitThisOnce(this);" accesskey="s" class="button_submit" />';

	if ($editor_context['preview_type'])
		echo ']]></add>
		</operation>
	</file>
	<file name="THEMEDIR/Memberlist.template.php">
		<operation>
			<search position="replace"><![CDATA[ * copyright:	2011 Simple Machines (http://www.simplemachines.org)
 * license:  	BSD, See included LICENSE.TXT for terms and conditions.
 *
 * @version 1.0.3
 *
 */
]]></search>
			<add><![CDATA[ * copyright:	2011 Simple Machines (http://www.simplemachines.org)
 * license:  	BSD, See included LICENSE.TXT for terms and conditions.
 *
 * @version 1.0.4
 *
 */
]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[	<form id="mlsearch" action="' . $scripturl . '?action=memberlist;sa=search" method="post" accept-charset="UTF-8">
		<ul class="floatright">
			<li>
				<input id="mlsearch_input" onfocus="toggle_mlsearch_opt();" type="text" name="search" value="" class="input_text" placeholder="' . $txt['search'] . '" />&nbsp;
				<input type="submit" name="search2" value="' . $txt['search'] . '" class="button_submit" />
				<ul id="mlsearch_options" class="nojs">';
]]></search>
			<add><![CDATA[	<form id="mlsearch" action="' . $scripturl . '?action=memberlist;sa=search" method="post" accept-charset="UTF-8">
		<ul class="floatright">
			<li>
				<input id="mlsearch_input" onfocus="toggle_mlsearch_opt();" type="text" name="search" value="' . $context['old_search_value'] . '" class="input_text" placeholder="' . $txt['search'] . '" />&nbsp;
				<input type="submit" name="search2" value="' . $txt['search'] . '" class="button_submit" />
				<ul id="mlsearch_options" class="nojs">';
]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[		<h2 class="category_header">
			<span class="floatleft">', $txt['members_list'], '</span>';

	if (!isset($context['old_search']))
		echo '
				<span class="floatright" letter_links>', $context['letter_links'], '</span>';

	echo '
		</h2>]]></search>
			<add><![CDATA[		<h2 class="category_header">
			<span class="floatleft">', $txt['members_list'], '</span>';

	if (!isset($context['in_search']))
		echo '
				<span class="floatright letter_links">', $context['letter_links'], '</span>';

	echo '
		</h2>]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[}

/**
 * Shows the search again button to allow editing the parameters
 */
function template_mlsearch_below()
{
	global $context, $scripturl, $txt;

	// If it is displaying the result of a search show a "search again" link to edit their criteria.
	if (isset($context['old_search']))
		$extra = '
			<a class="linkbutton_right" href="' . $scripturl . '?action=memberlist;sa=search;search=' . $context['old_search_value'] . '">' . $txt['mlist_search_again'] . '</a>';
	else
		$extra = '';

	// Show the page numbers again. (makes 'em easier to find!)
	template_pagesection(false, false, array('extra' => $extra));

	echo '
	</div>';]]></search>
			<add><![CDATA[}

/**
 * Shows the pagination
 */
function template_mlsearch_below()
{
	global $context, $scripturl, $txt;

	// Show the page numbers again. (makes 'em easier to find!)
	template_pagesection(false, false);

	echo '
	</div>';]]></add>
		</operation>
	</file>
	<file name="THEMEDIR/ModerationCenter.template.php">
		<operation>
			<search position="replace"><![CDATA[ * copyright:	2011 Simple Machines (http://www.simplemachines.org)
 * license:  	BSD, See included LICENSE.TXT for terms and conditions.
 *
 * @version 1.0
 *
 */
]]></search>
			<add><![CDATA[ * copyright:	2011 Simple Machines (http://www.simplemachines.org)
 * license:  	BSD, See included LICENSE.TXT for terms and conditions.
 *
 * @version 1.0.4
 *
 */
]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[		echo '
									</ul>
									<div class="pagesection notes">
										<span class="smalltext">', $context['page_index'], '</span>
									</div>';
	}
]]></search>
			<add><![CDATA[		echo '
									</ul>
									<div class="pagesection notes">
										<ul class="pagelinks">', $context['page_index'], '</ul>
									</div>';
	}
]]></add>
		</operation>
	</file>
	<file name="THEMEDIR/css/_besocial/index_besocial.css">
		<operation>
			<search position="replace"><![CDATA[div.bbc_footnotes .meaction {
	display: inline-block;
}


/*	$AJAX		*/]]></search>
			<add><![CDATA[div.bbc_footnotes .meaction {
	display: inline-block;
}
/* Prevent the footnote named anchor from hiding under the menu */
.bbc_footnotes div:before {
	display: block;
	content: " ";
	margin-top: -75px;
	height: 75px;
	visibility: hidden;
}


/*	$AJAX		*/]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[
.drop_area {
	-webkit-font-smoothing: antialiased;
	color: #43a8da;;
	background-color: #eee;
	border: 1px dashed #ccc;
	border-radius: 5px;]]></search>
			<add><![CDATA[
.drop_area {
	-webkit-font-smoothing: antialiased;
	color: #43a8da;
	background-color: #eee;
	border: 1px dashed #ccc;
	border-radius: 5px;]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[	.mlist li .group {
		border-right: 1px solid #ccc;
	}
}]]></search>
			<add><![CDATA[	.mlist li .group {
		border-right: 1px solid #ccc;
	}
}]]></add>
		</operation>
	</file>
	<file name="THEMEDIR/css/_light/index_light.css">
		<operation>
			<search position="replace"><![CDATA[
/* Test code - an attempt to make recent posts less overwhelming. */
#recentposts .inner {
	height: 7.2em;
	overflow: hidden;
	resize: vertical;
	position: relative;
}
#recentposts .inner blockquote {
	height: 1.5em;
	overflow: hidden;
}

/* floating error box */
/* currently used by like funcationality */]]></search>
			<add><![CDATA[
/* Test code - an attempt to make recent posts less overwhelming. */
#recentposts .inner {
	max-height: 20em;
	overflow: auto;
	position: relative;
}

/* floating error box */
/* currently used by like funcationality */]]></add>
		</operation>
	</file>
	<file name="THEMEDIR/css/admin.css">
		<operation>
			<search position="replace"><![CDATA[#package_list ol ul, #package_list ol ul li {
	margin-left: 0;
	list-style: none;
}
#package_list {
	list-style-type: none;]]></search>
			<add><![CDATA[#package_list ol ul, #package_list ol ul li {
	margin-left: 0;
	list-style: none;
	border-radius: 3px;
}
#package_list {
	list-style-type: none;]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[.package_server {
	padding: 0 3em;
}
ul.package_servers {
	margin: 0;
	padding: 0;]]></search>
			<add><![CDATA[.package_server {
	padding: 0 3em;
}
.package_image {
	width: 12px;
	height: 11px;
	margin-left: 2ex;
}
ul.package_servers {
	margin: 0;
	padding: 0;]]></add>
		</operation>
	</file>
	<file name="THEMEDIR/css/index.css">
		<operation>
			<search position="replace"><![CDATA[}

/* Upshrink image in the general category headers */
#category_toggle, #category_toggle_more, #upshrink_header {
	display: block;
	float: right;
	padding: 0 16px;
	overflow: hidden;
	position: relative;
}
#category_toggle span, #category_toggle_more span, #upshrink_header span {
	background-repeat: no-repeat;
	background-image: url(../images/_light/expcol.png);
	position: absolute;]]></search>
			<add><![CDATA[}

/* Upshrink image in the general category headers */
#category_toggle, #category_toggle_more, #upshrink_header, .package_toggle {
	display: block;
	float: right;
	padding: 0 16px;
	overflow: hidden;
	position: relative;
}
#category_toggle span, #category_toggle_more span, #upshrink_header span, .package_toggle span {
	background-repeat: no-repeat;
	background-image: url(../images/_light/expcol.png);
	position: absolute;]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[	display: block;
	overflow: hidden;
	max-width: 25em;
}
.linktree a {
	display: block;]]></search>
			<add><![CDATA[	display: block;
	overflow: hidden;
	max-width: 25em;
	text-overflow: ellipsis;
}
.linktree a {
	display: block;]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[}
/* Poll results */
#poll_options .results {
	display: inline;
}
#poll_options li {
	position: relative;
}
/* Absolute positioning stops these breaking the bars on narrow screens. */]]></search>
			<add><![CDATA[}
/* Poll results */
#poll_options .results {
	position: relative;
}
/* Absolute positioning stops these breaking the bars on narrow screens. */]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[	vertical-align: top;
	width: 15em;
	word-wrap: break-word;
	word-break: break-all;
	-webkit-hyphens: auto;
	-moz-hyphens: auto;
	-ms-hyphens: auto;]]></search>
			<add><![CDATA[	vertical-align: top;
	width: 15em;
	word-wrap: break-word;
	word-break: normal;
	-webkit-hyphens: auto;
	-moz-hyphens: auto;
	-ms-hyphens: auto;]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[	.linktree .board_moderators {
		display: none;
	}
	.statsbar .bar {
		max-width: 12em;
	}
	.signature {
		display: none;
	}]]></search>
			<add><![CDATA[	.linktree .board_moderators {
		display: none;
	}
	.signature {
		display: none;
	}]]></add>
		</operation>
	</file>
	<file name="LANGUAGEDIR/english/Packages.english.php">
		<operation>
			<search position="replace"><![CDATA[$txt['author_website'] = 'Author\'s Homepage';
$txt['package_no_description'] = 'No description given';
$txt['package_description'] = 'Description';
$txt['file_location'] = 'Location of file';

$txt['package_installed_key'] = 'Installed addons:';
$txt['package_installed_current'] = 'current version';]]></search>
			<add><![CDATA[$txt['author_website'] = 'Author\'s Homepage';
$txt['package_no_description'] = 'No description given';
$txt['package_description'] = 'Description';
$txt['file_location'] = 'Download';
$txt['bug_location'] = 'Issue tracker';
$txt['support_location'] = 'Support';
$txt['mod_hooks'] = 'No source edits';
$txt['mod_date'] = 'Last updated';
$txt['mod_section_count'] = 'Browse the (%1d) addons in this section';

$txt['package_installed_key'] = 'Installed addons:';
$txt['package_installed_current'] = 'current version';]]></add>
		</operation>
	</file>
	<file name="LANGUAGEDIR/english/index.english.php">
		<operation>
			<search position="replace"><![CDATA[$txt['mail_send_unable'] = 'Unable to send mail to the email address \'%1$s\'';

$txt['mlist_search'] = 'Search For Members';
$txt['mlist_search_again'] = 'Search again';
$txt['mlist_search_email'] = 'Search by email address';
$txt['mlist_search_group'] = 'Search by position';
$txt['mlist_search_name'] = 'Search by name';]]></search>
			<add><![CDATA[$txt['mail_send_unable'] = 'Unable to send mail to the email address \'%1$s\'';

$txt['mlist_search'] = 'Search For Members';
$txt['mlist_search_again'] = 'Search again'; // @deprecated since 1.0.4
$txt['mlist_search_email'] = 'Search by email address';
$txt['mlist_search_group'] = 'Search by position';
$txt['mlist_search_name'] = 'Search by name';]]></add>
		</operation>
	</file>
	<file name="THEMEDIR/scripts/admin.js">
		<operation>
			<search position="replace"><![CDATA[	var curType = document.getElementById("field_type").value,
		privStatus = document.getElementById("private").value,
		stdText = ['text', 'textarea', 'email', 'url', 'color', 'date'],
		stdInput = ['text', 'email', 'url', 'color', 'date'];

	var bIsStd = (stdInput.indexOf(curType) !== -1) ? true : false,
		bIsText = (stdText.indexOf(curType) !== -1) ? true : false;

	// Only Text like fields can see a max length input
	document.getElementById("max_length_dt").style.display = bIsText ? "" : "none";]]></search>
			<add><![CDATA[	var curType = document.getElementById("field_type").value,
		privStatus = document.getElementById("private").value,
		stdText = ['text', 'textarea', 'email', 'url', 'color', 'date'],
		stdInput = ['text', 'email', 'url', 'color', 'date'],
		stdSelect = ['select'];

	var bIsStd = (stdInput.indexOf(curType) !== -1) ? true : false,
		bIsText = (stdText.indexOf(curType) !== -1) ? true : false,
		bIsSelect = (stdSelect.indexOf(curType) !== -1) ? true : false;

	// Only Text like fields can see a max length input
	document.getElementById("max_length_dt").style.display = bIsText ? "" : "none";]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[	document.getElementById("mask_dt").style.display = bIsStd ? "" : "none";
	document.getElementById("mask").style.display = bIsStd ? "" : "none";

	// And text like fields can be searchable
	document.getElementById("can_search_dt").style.display = bIsText ? "" : "none";
	document.getElementById("can_search_dd").style.display = bIsText ? "" : "none";

	// Using regex in the mask, give them a place to supply the regex
	document.getElementById("regex_div").style.display = bIsStd && document.getElementById("mask").value === "regex" ? "" : "none";]]></search>
			<add><![CDATA[	document.getElementById("mask_dt").style.display = bIsStd ? "" : "none";
	document.getElementById("mask").style.display = bIsStd ? "" : "none";

	// And text and select fields are searchable
	document.getElementById("can_search_dt").style.display = bIsText || bIsSelect ? "" : "none";
	document.getElementById("can_search_dd").style.display = bIsText || bIsSelect ? "" : "none";
	
	// Moving to a non searchable field, be sure searchable is unselected.
	if (!bIsText && !bIsSelect)
		document.getElementById("can_search_dd").checked = false;

	// Using regex in the mask, give them a place to supply the regex
	document.getElementById("regex_div").style.display = bIsStd && document.getElementById("mask").value === "regex" ? "" : "none";]]></add>
		</operation>
	</file>
	<file name="THEMEDIR/scripts/jquery.sceditor.elkarte.js">
		<operation>
			<search position="replace"><![CDATA[ * copyright:	2011 Simple Machines (http://www.simplemachines.org)
 * license:		BSD, See included LICENSE.TXT for terms and conditions.
 *
 * @version 1.0.2
 * Extension functions to provide ElkArte compatibility with sceditor
 */
]]></search>
			<add><![CDATA[ * copyright:	2011 Simple Machines (http://www.simplemachines.org)
 * license:		BSD, See included LICENSE.TXT for terms and conditions.
 *
 * @version 1.0.4
 * Extension functions to provide ElkArte compatibility with sceditor
 */
]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[						e.preventDefault();
					})
				);

			if (line.children().length > 0)
				content.append(line);

			$(".sceditor-toolbar").append(content);
		},
		storeLastState: function (){
			this.wasSource = this.inSourceMode();]]></search>
			<add><![CDATA[						e.preventDefault();
					})
				);
		},
		storeLastState: function (){
			this.wasSource = this.inSourceMode();]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[			// show the standard placement icons
			$.each(emoticons, base.appendEmoticon);

			// Show the more button on the editor if we have more
			if (typeof moreButton !== "undefined")
				content.append(moreButton);]]></search>
			<add><![CDATA[			// show the standard placement icons
			$.each(emoticons, base.appendEmoticon);

			if (line.children().length > 0)
				content.append(line);

			$(".sceditor-toolbar").append(content);

			// Show the more button on the editor if we have more
			if (typeof moreButton !== "undefined")
				content.append(moreButton);]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[				date = ' date=' + $elm.attr('date');
			if ($elm.attr('link'))
				link = ' link=' + $elm.attr('link');

			return '[quote' + author + date + link + ']' + content + '[/quote]';
		},]]></search>
			<add><![CDATA[				date = ' date=' + $elm.attr('date');
			if ($elm.attr('link'))
				link = ' link=' + $elm.attr('link');
			if (author === '' && date === '' && link !== '')
				link = '=' + $elm.attr('link');

			return '[quote' + author + date + link + ']' + content + '[/quote]';
		},]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[			else if (typeof attrs.defaultattr !== "undefined")
			{
				// Convert it to an author tag
				attr_author = attrs.defaultattr;
				sAuthor = bbc_quote_from + ': ' + attr_author;
			}

			// Links could be in the form: link=topic=71.msg201#msg201 that would fool javascript, so we need a workaround]]></search>
			<add><![CDATA[			else if (typeof attrs.defaultattr !== "undefined")
			{
				// Convert it to an author tag
				attr_link = attrs.defaultattr;
				sLink = attr_link.substr(0, 7) === 'http://' ? attr_link : elk_scripturl + '?' + attr_link;
				sAuthor = '<a href="' + sLink + '">' + bbc_quote_from + ': ' + sLink + '</a>';
			}

			// Links could be in the form: link=topic=71.msg201#msg201 that would fool javascript, so we need a workaround]]></add>
		</operation>
		<operation>
			<search position="replace"><![CDATA[		breakStart: true,
		isInline: false,
		skipLastLineBreak: true,
		allowedChildren: ['*', 'li'],
		html: function(element, attrs, content) {
			var style = '',
				code = 'ul';]]></search>
			<add><![CDATA[		breakStart: true,
		isInline: false,
		skipLastLineBreak: true,
		allowedChildren: ['#', '*', 'li'],
		html: function(element, attrs, content) {
			var style = '',
				code = 'ul';]]></add>
		</operation>
	</file>
</modification>